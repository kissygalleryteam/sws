/*! sws - v1.0 - 2013-10-20 3:03:24 PM
* Copyright (c) 2013 Letao; Licensed  */
KISSY.add("gallery/sws/1.0/index",function(a,b,c){function d(b){var c=this;return this instanceof d?(d.superclass.constructor.call(c,b),c.config=b,c.set("container",a.one(b.container)),c.set("swsers",c.get("container").all(b.swsers)),c.set("colWidth",b.colWidth||100),c.set("space",b.space||10),c.set("offset",{x:b.offsetX||10,y:b.offsetY||10}),c.set("enableFill",b.enableFill),c.set("fillColor",b.fillColor),c.set("blankArea",[]),c.init(),void 0):new d(b)}return b.all,a.extend(d,c,{init:function(){var a=this,b=a.get("container");"static"===b.css("position")&&b.css("position","relative"),a.reposition()},reposition:function(){var a=this;a.getCols(),a.initColArray();var b=a.get("swsers");b.length;var c=a.get("container"),d=c.width(),e=a.get("colWidth"),f=a.get("space"),g=a.get("offset"),h=a.get("blankArea");h.splice(0,h.length),b.each(function(b){var c=b.width(),i=b.height(),j=h.length,k=!1;if(j>0&&(k=a.insertBlankArea(b)),!k){for(var l=a.get("colArr"),m=a.getMinCol(l),n=(c+f)/(e+f),o=1;m*(e+f)+c+g.x>d;)m=a.getMinCol(l,o++);var p=m;a.hasCross(m,n)&&(p=a.getMaxCol(l,m,n));var q=m*(e+f)+g.x,r=l[p].height;b.css({left:q,top:r}),a.addBlankArea(m,n,r);for(var s=m,t=m+n;t>s;s++)l[s].height=r+i+f}}),a.get("enableFill")&&a.fillWithDiv(),a.setContainerHeight()},getRandomColor:function(){var a=16777215,b=Math.round(Math.random()*a);return b=b.toString(16),"#"+("00000"+b).slice(-6)},addItems:function(b){var c=this,d=c.get("container"),b=a.clone(b),e=c.get("colWidth"),f=d.width(),g=c.get("space"),h=c.get("offset"),i=c.get("blankArea");a.each(b,function(b){b=a.one(b),d.append(b);var j=b.width(),k=b.height(),l=i.length,m=!1;if(l>0&&(m=c.insertBlankArea(b)),!m){for(var n=c.get("colArr"),o=c.getMinCol(n),p=(j+g)/(e+g),q=1;o*(e+g)+j+h.x>f;)o=c.getMinCol(n,q++);var r=o;c.hasCross(o,p)&&(r=c.getMaxCol(n,o,p));var s=o*(e+g)+h.x,t=n[r].height;b.css({left:s,top:t}),c.addBlankArea(o,p,t);for(var u=o,v=o+p;v>u;u++)n[u].height=t+k+g}}),c.get("enableFill")&&c.fillWithDiv(),c.setContainerHeight(),c.set("swsers",d.all(c.config.swsers))},setContainerHeight:function(){var a=this,b=a.get("colArr"),c=a.get("container"),d=a.getMaxHeight(b);c.css("height",d)},getMaxHeight:function(a){for(var b=a[0].height,c=a.length,d=0;c>d;d++)b<a[d].height&&(b=a[d].height);return b},addBlankArea:function(a,b,c){for(var d=this,e=d.get("blankArea"),f=d.get("colWidth"),g=d.get("space"),h=d.get("colArr"),i=d.get("offset"),j=0,k=a;b>j;j++){var l=j+k;if(h[l].height<c){for(var m=f;b>j+1&&h[j+k].height===h[j+k+1].height;)m+=f+g,j++;j=j>0?j--:j,e.push({left:l*(f+g)+i.x,top:h[l].height,width:m,height:c-h[l].height-g})}}},getMaxCol:function(b,c,d){for(var e=a.clone(b),f=c,g=e[f].height,h=c,i=c+d;i>h;h++)g<e[h].height&&(f=h,g=e[f].height);return f},fillWithDiv:function(){var b=this,c=b.get("fillColor"),d=a.one('<div class="J_Filler" style="position: absolute;">'),e=b.get("blankArea"),f=b.get("container"),g=f.all(".J_Filler");g.each(function(a){a.remove()}),a.each(e,function(a){if(a.height>10){var e=d.clone();f.append(e),e.css({left:a.left,top:a.top,width:a.width,height:a.height,backgroundColor:c||b.getRandomColor()})}})},insertBlankArea:function(b){for(var c=this,d=c.get("blankArea"),e=d.length,f=b.width(),g=b.height(),h=c.get("space"),i=a.clone(d),j=!1,k=0;e>k;k++)if(i[k].width>=f&&i[k].height>=g){b.css({left:i[k].left,top:i[k].top});var l=i[k].width-f-h;0!==l&&d.push({left:i[k].left+f+h,top:i[k].top,width:l,height:i[k].height}),i[k].top+=g+h,i[k].width=f,i[k].height-=g+h,0!==i[k].height?d.splice(k,1,i[k]):d.splice(k,1),j=!0;break}return j},hasCross:function(a,b){for(var c=this,d=c.get("colArr"),e=d.length,f=!1,g=a,h=a+b;h>g;g++){if(g>=e){f=!0;break}if(d[g].height>d[a].height){f=!0;break}f=!1}return f},getMinCol:function(b,c){for(var c=c||0,d=a.clone(b),e=d.length,f=null,g=0;e>g;g++)for(var h=0;e-1>h;h++)d[h].height>d[h+1].height&&(f=d[h],d[h]=d[h+1],d[h+1]=f);return d[c].index},initColArray:function(){for(var a=this,b=a.get("cols"),c=a.get("offset"),d=[],e=0;b>e;e++)d.push({height:c.y,index:e});return a.set("colArr",d),d},getCols:function(){var a=this,b=a.get("container"),c=b.width(),d=0,e=a.get("colWidth"),f=a.get("space");return d=Math.floor((c+f)/(e+f)),a.set("cols",d),d}},{ATTRS:{}}),d},{requires:["node","base"]});